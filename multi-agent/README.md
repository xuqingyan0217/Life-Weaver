项目名称：Life Weaver（生活编织者/画布）

结合你的前端编排能力（支持代办、照片、日记等内容的串联）和后端多智能体处理能力，以下是最符合的应用场景方向及具体落地建议：

### 一、核心场景定位：**「个人数字生活的智能整合与价值升华」**
通过前端自由编排+后端AI多智能体处理，将零散的生活碎片转化为**有逻辑、有温度、可复用的结构化成果**，满足用户在**记录、管理、创作、成长**四大维度的深层需求。


### 二、六大黄金应用场景（附落地案例）
#### 场景1：**智能生活日志与成长档案**
- **核心价值**：打破“碎片化记录”与“深度复盘”的割裂，让每日/每周的生活痕迹自动生成**可追溯的成长证据链**。
- **具体实现**：
    - **前端编排**：按时间轴或主题（如“职业突破”“亲子时光”）串联待办、照片、日记、消费记录等；
    - **后端多智能体处理**：
        - **智能摘要生成**：通过NLP分析日记内容，提炼本周“3大成长点”“2个待改进问题”；
        - **数据可视化**：用图表呈现运动频次、消费趋势、情绪波动（结合日记关键词），生成《月度生活健康报告》；
        - **记忆增强**：自动识别照片中的场景（如“2025年5月黄山旅行”），关联同期日记和待办事项，形成沉浸式回忆包。
- **用户案例**：用户小张用此功能生成《2025年度职场成长白皮书》，包含项目待办完成率、客户沟通日记、培训照片等，在求职时作为差异化竞争力。

#### 场景2：**个性化内容创作与灵感引擎**
- **核心价值**：将零散的生活素材转化为**可对外输出的创意内容**，降低创作门槛。
- **具体实现**：
    - **前端编排**：按“主题-素材-结构”搭建内容框架（如“川西自驾攻略”需串联行程待办、沿途照片、每日日记）；
    - **后端多智能体处理**：
        - **内容优化**：通过风格迁移智能体重写日记，适配小红书/公众号等平台格式；
        - **素材补充**：识别照片中的景点，自动调用网络API添加历史背景、游玩贴士，生成《带爸妈游故宫深度指南》；
        - **跨模态创作**：将旅行照片+日记+音乐自动合成为短视频，AI配音并添加字幕。
- **用户案例**：自媒体创作者小李用此功能快速产出系列游记，月均内容产量提升3倍，单篇最高阅读量超10万。

#### 场景3：**任务驱动的生活管理中枢**
- **核心价值**：通过“记录-分析-执行”闭环，让待办事项与生活记录相互赋能，提升行动力。
- **具体实现**：
    - **前端编排**：在时间轴上叠加待办任务与对应生活记录（如“健身计划”关联运动照片和饮食日记）；
    - **后端多智能体处理**：
        - **任务优先级预测**：结合历史完成效率、照片中的场景（如“加班照片”）、日记情绪（如“疲惫”），动态调整次日待办顺序；
        - **习惯追踪强化**：自动统计“早起打卡”关联的晨间日记内容，生成《习惯养成可视化图谱》，用游戏化勋章激励用户；
        - **跨平台同步**：将待办事项与手机日历、运动APP数据打通，实现“一键同步+自动提醒”。
- **用户案例**：职场妈妈王女士用此功能管理育儿、工作、健身，待办完成率从60%提升至92%，家庭出游筹备效率翻倍。

#### 场景4：**情感化社交分享与亲密互动**
- **核心价值**：将个人记录转化为**有情感共鸣的社交货币**，增强与他人的连接。
- **具体实现**：
    - **前端编排**：按“情感主题”（如“父爱如山”“闺蜜十年”）整合照片、语音日记、聊天记录；
    - **后端多智能体处理**：
        - **情感分析**：识别日记中的情感关键词（如“感动”“怀念”），生成个性化祝福语或纪念文案；
        - **隐私保护**：支持按角色（如“家人”“朋友”）设置不同的内容可见权限，敏感信息自动模糊处理；
        - **多人协作**：邀请家人共同编辑“家庭大事记”，AI自动汇总每个人的记录并生成年度电子相册。
- **用户案例**：大学生小陈用此功能为奶奶制作《八十大寿纪念册》，整合家庭照片、子孙语音祝福、历年春节日记，引发家族群泪目传播。

#### 场景5：**AI驱动的自我认知与成长教练**
- **核心价值**：通过长期数据积累，用AI多智能体提供**个性化的自我提升建议**。
- **具体实现**：
    - **前端编排**：按“自我维度”（如“认知”“情绪”“关系”）整合学习笔记、情绪日记、社交照片；
    - **后端多智能体处理**：
        - **认知图谱构建**：分析学习笔记和待办事项，绘制“知识盲区热力图”，推荐针对性学习资源；
        - **情绪预警系统**：通过日记文本分析和照片表情识别，提前3天预测情绪低谷期并推送缓解方案；
        - **目标拆解引擎**：将长期目标（如“3年内晋升经理”）拆解为可量化的月度任务，关联待办事项和成长记录。
- **用户案例**：职场新人小赵用此功能发现“沟通能力”是晋升瓶颈，AI推荐《非暴力沟通》书籍+模拟对话训练，6个月后成功晋升。

#### 场景6：**企业级员工关怀与文化建设（B端延伸）**
- **核心价值**：为企业提供**轻量化的员工生活管理工具**，增强归属感。
- **具体实现**：
    - **前端编排**：企业定制模板（如“企业文化践行”“员工健康管理”），员工自主填充内容；
    - **后端多智能体处理**：
        - **文化落地**：自动识别员工记录中的“团队协作”“创新突破”案例，生成《企业文化案例库》用于培训；
        - **健康干预**：汇总员工运动、饮食记录，AI生成健康报告并推送定制化建议，降低企业医疗成本；
        - **人才评估**：通过待办完成率、项目记录等数据，为HR提供“隐性能力评估”参考。
- **用户案例**：某互联网公司引入此功能后，员工文化认同感提升40%，年度离职率下降18%。


### 三、差异化竞争策略：**「用户主导+AI赋能」的双向价值强化**
1. **前端编排：极致自由与结构化平衡**
    - 提供“自由拖拽+智能模板”双模式：新手可套用预设模板（如“旅行日志”“年度总结”），高手可自定义字段、布局、交互逻辑；
    - 支持跨平台素材导入：一键同步手机相册、邮箱附件、第三方APP数据（如Keep、印象笔记）。

2. **后端多智能体：分工协作的智能处理网络**
    - 设计“编排-分析-优化-生成”多智能体协作链路：
        - **编排智能体**：理解用户编排逻辑，预判内容用途（如“分享”“复盘”）；
        - **分析智能体**：对文本、图像、语音进行情感分析、实体识别、关联推荐；
        - **优化智能体**：自动调整内容结构、语言风格、排版布局；
        - **生成智能体**：根据用户需求生成新内容（如总结报告、创意文案、短视频）。

3. **用户体验：从工具到伙伴的情感连接**
    - 加入“时光胶囊”功能：用户可设置未来开启时间，AI根据历史记录生成“给未来自己的信”；
    - 开发“AI记忆助手”：通过自然语言交互，实现“查询记忆”“补充记录”“生成建议”等功能；
    - 构建“记忆社区”：用户可匿名分享内容，参与话题挑战（如“30天成长打卡”），形成UGC生态。

---

### 后端架构与模式总览（维护扩展用）

- 核心目标：将前端编排的内容图转化为可执行的最简代理图，通过多智能体（监督者+文本代理+视觉代理）按拓扑顺序执行，并以 SSE 流式输出增量文本至前端。
- 关键模块：
  - `internal/httpserver`：Gin HTTP 服务与路由，封装图执行接口与流式输出；同时提供图片上传/访问/删除。
  - `internal/orchestrator`：看板导出转规范化结构与最简代理图生成（`BoardExport → Canonical → SimpleGraph`）。
  - `internal/graphproc`：图执行、智能体构建、流式打印与 token 使用提取。
  - `model/`：大模型选择（Ark 或 OpenAI），通过环境变量切换。

**目录结构（摘要）**
- `main.go`：HTTP 服务入口。
- `internal/httpserver/server.go`：路由与 SSE 包装。
- `internal/orchestrator/{model.go, parser.go, agent.go, run.go}`：数据模型与图生成。
- `internal/graphproc/{loader.go, agents.go, processor.go, runner.go, stream.go, types.go}`：图执行与流式输出。
- `cmd/summarize`：从 `board-export.json` 生成 `agent-graph.json`。
- `cmd/process-graph`：本地读取 `agent-graph.json` 执行并在控制台流式打印（不返回最终 JSON）。

---

### 接口与数据约定

**1) 执行最简代理图** `POST /api/graph/process`
- 请求体（二选一提供 `file` 或 `graph`）：
  - `file`：字符串路径，后端读取该文件为 SimpleGraph。
  - `graph`：`orchestrator.SimpleGraph`，直接按图执行。
  - `verbose`：布尔，是否开启详细事件打印（仅影响控制台/日志）。
  - `stream`：布尔，是否启用 SSE 流式返回。
- 行为与返回：
  - 当 `stream=false`（默认非流）：返回 JSON `{status, nodes, edges, results}`，其中 `results` 为每节点的 `NodeResult`（含 `kind/output/error` 与可用的 token 计数）。不返回逐字输出。
  - 当 `stream=true`：返回 `text/event-stream`，仅推送增量文本，不再返回最终结果 JSON（连接结束即完成）。
    - SSE 数据事件格式：后端将流式打印统一封装为 `data:` 事件块；错误则使用 `event: error + data: ...`。
    - 每个节点开始时会推送边界行：`=== node=<id> ===`（来自 `StreamPrinter.Begin`）。前端据此切换当前节点的渲染面板。

示例（精简）：
```
event: error
data: process graph: <错误信息>

data: === node=key-label-1 ===\n开始流式输出...（按模型返回增量拼接）

data: === node=quote-card-1 ===\n继续输出...
```

**2) 图摘要生成** `POST /api/graph/summarize`
- 请求体：
  - `file`：可选，传入看板导出文件路径；或直接传 `board`（`BoardExport`）。
  - `agent_out`：可选，若提供则将生成的最简代理图写入该文件。
- 返回：`{status, nodes, edges, graph}`，其中 `graph` 为 `SimpleGraph`。

**3) 图片接口**
- `POST /api/images`：上传图片，返回 `{id, url}`。
- `GET /api/images/:id`：按 id 获取图片内容（`Content-Type` 依据扩展名）。
- `DELETE /api/images/:id`：删除图片。

---

### 执行与流式模式（内部原理）

- 构建智能体：`graphproc.BuildAgents()` 返回三者：
  - `graph_supervisor`：只做路由决策（文本/视觉），要求严格 JSON 响应，不自行完成任务。
  - `text_agent`：文本分析与要点提炼；支持在有前驱输出时进行关联分析。
  - `vision_agent`：图像分析；从负载中提取 `imageUrl`，获取后进行描述与简要分析。
- 图执行：`graphproc.ProcessGraph(...)`
  - 使用 Kahn 算法进行分层推进，层内并发上限默认 `maxConcurrent=4`。
  - 对每节点：汇总所有前驱的输出 → 询问监督者 → 显式调用对应子代理 → 写入 `NodeResult`。
  - 流式输出：`runner.go` 通过 `adk.Runner` 消费模型事件流；若开启流式（默认），优先 Drain `MessageStream`，否则回退到最终消息一次性输出。
  - 打印器：`StreamPrinter` 保证节点级别的串行打印，避免并发混流；边界 `\n=== node=<id> ===\n` 由 `Begin()` 打印。
  - token 用量：通过反射读取 `ResponseMeta.Usage`，记录至 `NodeResult` 与汇总结构（若模型提供）。

---

### 数据模型（orchestrator）

- `BoardExport`：前端导出的原始结构，包含画布、节点、边。
- `Canonical`：规范化结构，清洗节点与有效边，抽取 `Node.Text` 以辅助监督者判断。
- `SimpleGraph`：最简代理图，仅 `nodes[id,payload]` 与 `edges[from,to]`。
- 生成路径：`ParseBoardExport → BuildSimpleGraph`；也支持直接由前端按此结构传入执行。

---

### 模型与环境变量

- 切换模型：`MODEL_TYPE=ark` 或 `openai`（默认 OpenAI）。
- Ark 所需：`ARK_API_KEY`, `ARK_MODEL`, `ARK_BASE_URL`。
- OpenAI 所需：`OPENAI_API_KEY`, `OPENAI_MODEL`, `OPENAI_BASE_URL`, `OPENAI_BY_AZURE`（如走 Azure）。
- 示例：见根目录 `.env`。

---

### 启动、构建与本地验证

- 启动 HTTP 服务：
  - `go run ./main.go`
- 本地执行最简图（控制台流式验证）：
  - `go run ./cmd/process-graph -file ../agent-graph.json -verbose=true`
- 生成最简图：
  - `go run ./cmd/summarize -file ../board-export.json -agent_out ../agent-graph.json`

---

### 前后端流式契约（SSE）

- 连接：`Accept: text/event-stream`，返回头 `Content-Type: text/event-stream; charset=utf-8`。
- 事件：
  - 正常增量：`data: <chunk>\n\n`，可能包含多行（包括边界行）。
  - 错误：`event: error\ndata: <message>\n\n`。
- 节点边界：每个节点开始输出时，先推送 `=== node=<id> ===`，前端据此切换当前节点面板并把后续文本累积到对应 `nodeStreams[id]`。
- 前端适配（已实现于 `flow-web/useBoardActions.js`）：
  - 以空行分段解析事件块，取 `data:` 后整段作为正文；识别边界切换节点；增量文本直接拼接，不再强制逐 token 换行。

---

### 维护/扩展建议

- 新增工具/能力：可在 `text_agent`/`vision_agent` 的 `ToolsConfig` 中挂载工具（如图片下载、知识库检索）。
- 路由策略强化：监督者可读取 `Canonical.Node.Text` 与 `payload` 更多字段，形成更细粒度的路由决策。
- 并发与容错：
  - 调整层内并发上限；为模型调用增加超时与重试（当前通过 Runner 事件消费，未显式重试）。
  - 错误事件已通过 SSE 发送，前端可据此降级展示或提示重试。
- 日志与监控：
  - `internal/logs` 可接入文件滚动与结构化日志；为 `ProcessGraph` 增加节点级耗时统计。
- 成本度量：依赖模型返回的 `Usage` 字段；如需强制统计，可在消息末尾注入能被模型返回的 token 使用信息或外部估算。

---

### 常见问题（FAQ）

- 为什么流式模式不返回最终 JSON？
  - 设计上更贴合逐节点的交互体验；最终结果由前端基于 `nodeStreams` 实时呈现。如需 JSON，可在非流模式下获取 `results`。
- 边界行为什么与 `data:` 不在同一行？
  - `StreamPrinter.Begin` 会打印一个前导换行以便视觉分隔；前端已适配为“取整段正文”。如需严格 SSE 每行前缀，可在服务端为每行加 `data:`。
- 如何让视觉代理读取图片？
  - 从 `payload.imageUrl` 读取链接；可扩展工具从 `GET /api/images/:id` 拉取数据 URL 后再分析。

---

### 版本记录（后端）

- 2025-11：
  - 增补 README（后端架构、接口、SSE 契约、运维与扩展建议）。
  - 流式模式与前端契约统一：`data:` 事件块 + 节点边界行。
  - 非流模式仅返回 `results`；移除最终输出文本的 JSON 回传。